#!/usr/bin/python
from docker import Client

dockerCli = Client(base_url='unix://var/run/docker.sock')


# For every virtual host defined
{{ range $host, $containers := groupByMulti $ "Env.VIRTUAL_HOST" "," }}

	{{ $maxTag := -1 }}
	
	# For every container inside that host
	{{ range $container := $containers }}
		{{ if $container.Image.Tag }}
				{{ if strconv.Atoi($container.Image.Tag) > $maxTag }}
					{{	$maxTag := $container.Image.Tag }}
				{{ end }}
		{{ end }}
	{{end}}

	{{ if $maxTag > -1 }}
		{{ range $container := $containers }}
			{{ if $container.Image.Tag != $maxTag }}
				# Stop this container, but allow it to exit gracefully (T= 1 hour)
				dockerCli.stop("{{ $container.ID }}", 60*60)
			{{ end }}
		{{ end }}
	{{ end }}
	
{{end}}